<!DOCTYPE HTML>
<html>
<head>
<title>pixi.js example 1</title>
<style>
body {
    margin: 0;
    padding: 0;
    background-color: #000000;
    overflow: hidden;
}
</style>
<script src="keydrown.min.js"></script>
<script src="pixi.js"></script>
<script src="stats.min.js"></script>
</head>
<body>
<script>
// Stats
var stats = new Stats();
stats.setMode(0);
stats.domElement.style.position = 'absolute';
stats.domElement.style.left = '0px';
stats.domElement.style.top = '0px';
document.body.appendChild( stats.domElement );

// Pixi setup
var h = window.innerHeight;
var w = window.innerWidth;
var NUM_STARS = 50;
var MAX_VEL = 10;
var stage = new PIXI.Stage(0x000000);
var renderer = PIXI.autoDetectRenderer(w, h);
document.body.appendChild(renderer.view);

stage.setInteractive(true);
stage.tap = function(data) {
    players[0].rotation = Math.atan2(data.global.x - w/2, -1 * (data.global.y - h/2));
    players[0].velocity = MAX_VEL;
}

var playerTexture = PIXI.Texture.fromImage("player.png");
var playerLeftTexture = PIXI.Texture.fromImage("playerLeft.png");
var playerRightTexture = PIXI.Texture.fromImage("playerRight.png");
var starTexture = PIXI.Texture.fromImage("starSmall.png");
var meteorTexture = PIXI.Texture.fromImage("meteorBig.png");

function Player(up, left, down, right) {
    PIXI.Sprite.call(this, playerTexture);
    this.velocity = 0;
    this.anchor.x = 0.5;
    this.anchor.y = 0.5;
    this.moveV = new PIXI.Point(0,0);

    world.addChild(this);

    var t = this
    kd[up].down(function() {
        if(t.velocity < MAX_VEL) {
            t.velocity += 0.1;
        }
    })
    kd[down].down(function() {
        if (t.velocity > 0) {
            t.velocity -= 1;
        } else if(t.velocity > -MAX_VEL) {
            t.velocity -= 0.05;
        }
    })
    kd[left].down(function() {
        t.setTexture(playerRightTexture);
        t.rotation -= 0.1;
    })
    kd[right].down(function () {
        t.setTexture(playerLeftTexture);
        t.rotation += 0.1;
    })
    kd[left].up(function() {
        t.setTexture(playerTexture);
    })
    kd[right].up(function() {
        t.setTexture(playerTexture);
    })
}
Player.prototype = Object.create(PIXI.Sprite.prototype);
Player.prototype.move = function() {
    this.moveV.x = this.velocity * Math.cos(this.rotation - Math.PI / 2);
    this.moveV.y = this.velocity * Math.sin(this.rotation - Math.PI / 2);
    this.position.x += this.moveV.x;
    this.position.y += this.moveV.y;
}

var players = new Array();

var stars = new PIXI.DisplayObjectContainer();
var world = new PIXI.DisplayObjectContainer();

for(var i = 0; i < NUM_STARS; i++) {
    var star = new PIXI.Sprite(starTexture);
    star.position.x = Math.floor(Math.random() * w);
    star.position.y = Math.floor(Math.random() * h);
    star.rotation = Math.random() * 2 * Math.PI;
    var scale = 0.4 + Math.random() * 0.8;
    star.rscale = new PIXI.Point(scale, scale);
    stars.addChild(star);
}
var meteor = new PIXI.Sprite(meteorTexture);
meteor.anchor.x = 0.5;
meteor.anchor.y = 0.5;

var debug = new PIXI.Text("debug...",{font:"12px Arial", fill:"blue"});
debug.anchor.y = 1.0;
debug.position.y = h;

world.position.x = w / 2;
world.position.y = h / 2;
world.addChild(meteor);

players.push(new Player("W", "A", "S", "D"));
players.push(new Player("UP", "LEFT", "DOWN", "RIGHT"));
// players.push(new Player("Y", "G", "H", "J"));

stage.addChild(stars);
stage.addChild(debug);
stage.addChild(world);
var move = new PIXI.Point(0,0);
var center = new PIXI.Point(0,0);

function draw() {
    stats.begin();
    kd.tick();

    move.x = 0;
    move.y = 0;
    center.x = 0;
    center.y = 0;

    for(var i = 0; i < players.length; i ++) {
        players[i].move();

        move.x += players[i].moveV.x;
        move.y += players[i].moveV.y;

        center.x += players[i].position.x;
        center.y += players[i].position.y;
    }

    center.x = center.x / players.length;
    center.y = center.y / players.length;
    var cx = (w/2) + Math.abs(center.x) * world.scale.x;
    var cy = (h/2) + Math.abs(center.y) * world.scale.y;
    var scale = 1;
    for(var i = 0; i < players.length; i++) {
        var absx = Math.abs(players[i].position.x) + 100 ;
        var absy = Math.abs(players[i].position.y) + 100 ;
        if (absx > cx) {
            scale = Math.min(scale, cx/absx);
        }
        if (absy > cy) {
            scale = Math.min(scale, cy/absy);
        }
    }
    debug.setText(scale);
    world.scale.x = scale;
    world.scale.y = scale;
    world.position.x = w/2 - center.x * scale;
    world.position.y = h/2 - center.y * scale;

    for(var i = 0; i < stars.children.length; i++) {
        var star = stars.getChildAt(i);

        star.scale.x = star.rscale.x * scale + 0.3 * (1-scale);
        star.scale.y = star.rscale.y * scale + 0.3 * (1-scale);

        star.position.x += (0.2 * star.scale.x) * -move.x;
        star.position.y += (0.2 * star.scale.y) * -move.y;
        if(star.position.x > w) {
            star.position.y = Math.random() * h;
            star.position.x = 0;
        } else if (star.position.x < 0) {
            star.position.y = Math.random() * h;
            star.position.x = w;
        }
        if(star.position.y > h) {
            star.position.y = 0;
            star.position.x = Math.random() * w;
        } else if (star.position.y < 0) {
            star.position.y = h;
            star.position.x = Math.random() * w;
        }
    }

    requestAnimFrame(draw);
    renderer.render(stage);
    stats.end();
}
requestAnimFrame(draw);
</script>
</body>
</html>
